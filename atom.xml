<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>陈大狗</title>
  <icon>https://www.gravatar.com/avatar/062a63189d8f41945b4750defa3d5f27</icon>
  <subtitle>你要感谢告诉你缺点的人</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://saburo90.github.io/"/>
  <updated>2020-03-14T01:20:19.775Z</updated>
  <id>http://saburo90.github.io/</id>
  
  <author>
    <name>陈大狗</name>
    <email>saburo90@163.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>利用Dockerfile基于Centos8构建nginx镜像</title>
    <link href="http://saburo90.github.io/2020/03/08/nginx-dockerfile/"/>
    <id>http://saburo90.github.io/2020/03/08/nginx-dockerfile/</id>
    <published>2020-03-08T09:02:17.000Z</published>
    <updated>2020-03-14T01:20:19.775Z</updated>
    
    <content type="html"><![CDATA[<h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><a id="more"></a><ul><li><p>系统</p><ul><li>Windows 10</li></ul></li><li><p>工具</p><ul><li>docker </li></ul></li><li><p>生成ssh公钥</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>在Dockerfile所在目录创建sshd服务启动shell脚本<code>run.sh</code></p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">/usr/sbin/sshd -D</span><br></pre></td></tr></table></figure></li><li><p>复制公钥到Dockerfile所有目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat ~/.ssh/id_rsa.pub &gt; DOCKERFILE_PATH/authorized_keys</span><br></pre></td></tr></table></figure></li></ul><h4 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h4><ul><li><p>注册docker-hub账号</p></li><li><p>下载<a href="https://hub.docker.com/?overlay=onboarding" target="_blank" rel="noopener">Docker Desktop for Windows</a>，如下图点击下载：</p><p><img src="/assets/blogImages/nginx-dockerfile/docker-desktop-install.png" alt="docker-desktop-install"></p></li><li><p>为docker配置镜像加速，配置<a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors" target="_blank" rel="noopener">阿里云容器镜像服务镜像加速器</a></p><ul><li>阿里云容器镜像服务镜像加速器</li></ul><p><img src="/assets/blogImages/nginx-dockerfile/mirror-speed.png" alt="mirror-speed"></p><ul><li><p>修改本机docker镜像为阿里云镜像加速器</p><p><img src="/assets/blogImages/nginx-dockerfile/set-repository.png" alt="set-repository"></p></li></ul></li></ul><h4 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:latest</span><br><span class="line"><span class="keyword">MAINTAINER</span> saburo</span><br><span class="line"><span class="comment"># 时间改为中国时间</span></span><br><span class="line"><span class="keyword">ENV</span> TIME_ZONE=Asia/Shanghai</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;TIME_ZONE&#125;</span>"</span> &gt; /etc/timezone</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ln -sf /usr/share/zoneinfo/<span class="variable">$&#123;TIME_ZONE&#125;</span> /etc/localtime</span></span><br><span class="line"><span class="comment"># 安装切换镜像的依赖及下载工具</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install yum-utils wget -y</span></span><br><span class="line"><span class="comment"># 配置阿里Centos8镜像源</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> rm -rf /etc/yum.repos.d/*;wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo</span></span><br><span class="line"><span class="comment"># 生成缓存</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum makecache</span></span><br><span class="line"><span class="comment"># 安装相关依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install make wget tar gzip passwd openssh-server gcc pcre-devel openssl-devel net-tools vim -y</span></span><br><span class="line"><span class="comment"># 配置SSHD&amp;修改root密码为saburo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ssh-keygen -q -t rsa -b 2048 -f /etc/ssh/ssh_host_rsa_key -N <span class="string">''</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ssh-keygen -q -t ecdsa -f /etc/ssh/ssh_host_ecdsa_key -N <span class="string">''</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ssh-keygen -q -t ed25519 -f /etc/ssh/ssh_host_ED25519_key -N <span class="string">''</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">'saburo'</span> | passwd --stdin root</span></span><br><span class="line"><span class="comment"># 创建sshd运行脚本目录</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /var/run/sshd</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /root/.ssh</span></span><br><span class="line"><span class="comment"># 取消pam限制</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sed -ri <span class="string">'s/session    required     pam_loginuid.so/#session    required     pam_loginuid.so/g'</span> /etc/pam.d/sshd</span></span><br><span class="line"><span class="comment"># 复制配置文件到相应位置，并赋予脚本可执行权限</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> authorized_keys /root/.ssh/authorized_keys</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> run.sh /run.sh</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod 755 /run.sh</span></span><br><span class="line"><span class="comment"># 添加nginx运行用户及用户组，并禁止登陆</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> groupadd www</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> useradd -g www:www -s /bin/<span class="literal">false</span></span></span><br><span class="line"><span class="comment"># 统一管理nginx版本号</span></span><br><span class="line"><span class="keyword">ENV</span> VERSION <span class="number">1.16</span>.<span class="number">1</span></span><br><span class="line"><span class="comment"># 下载解压nginx源码包</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /usr/<span class="built_in">local</span>/src/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> http://nginx.org/download/nginx-<span class="variable">$&#123;VERSION&#125;</span>.tar.gz /usr/<span class="built_in">local</span>/src/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> tar -zxvf /usr/<span class="built_in">local</span>/src/nginx-<span class="variable">$&#123;VERSION&#125;</span>.tar.gz -C /usr/<span class="built_in">local</span>/src/</span></span><br><span class="line"><span class="comment"># 进入nginx源码解压目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /usr/<span class="built_in">local</span>/src/nginx-<span class="variable">$&#123;VERSION&#125;</span></span></span><br><span class="line"><span class="comment"># 隐藏web服务器版本号</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sed -i -e <span class="string">"s/1\.16\.1//g' -e 's/nginx\//WS/g' -e 's/"</span>NGINX<span class="string">"/"</span>WS<span class="string">"/g' ./src/core/nginx.h</span></span></span><br><span class="line"><span class="comment"># 创建nginx安装目录</span></span><br><span class="line"><span class="keyword">ENV</span> NGINX_HOME /usr/local/nginx</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p <span class="variable">$&#123;NGINX_HOME&#125;</span>;chown -R www:www <span class="variable">$&#123;NGINX_HOME&#125;</span></span></span><br><span class="line"><span class="comment"># 编译安装nginx</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ./configure \</span></span><br><span class="line"><span class="bash">    --prefix=<span class="variable">$&#123;NGINX_HOME&#125;</span> \</span></span><br><span class="line"><span class="bash">    --sbin-path=<span class="variable">$&#123;NGINX_HOME&#125;</span>/sbin/nginx \</span></span><br><span class="line"><span class="bash">    --conf-path=<span class="variable">$&#123;NGINX_HOME&#125;</span>/conf/nginx.conf \</span></span><br><span class="line"><span class="bash">    --error-log-path=/var/<span class="built_in">log</span>/nginx/error.log \</span></span><br><span class="line"><span class="bash">    --http-log-path=/var/<span class="built_in">log</span>/nginx/access.log \</span></span><br><span class="line"><span class="bash">    --pid-path=/var/run/nginx.pid \</span></span><br><span class="line"><span class="bash">    --lock-path=/var/run/nginx.lock \</span></span><br><span class="line"><span class="bash">    --http-client-body-temp-path=/var/cache/nginx/client_temp \</span></span><br><span class="line"><span class="bash">    --http-proxy-temp-path=/var/cache/nginx/proxy_temp \</span></span><br><span class="line"><span class="bash">    --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \</span></span><br><span class="line"><span class="bash">    --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \</span></span><br><span class="line"><span class="bash">    --http-scgi-temp-path=/var/cache/nginx/scgi_temp \</span></span><br><span class="line"><span class="bash">    --user=www \</span></span><br><span class="line"><span class="bash">    --group=www \</span></span><br><span class="line"><span class="bash">    --with-pcre \</span></span><br><span class="line"><span class="bash">    --with-http_v2_module \</span></span><br><span class="line"><span class="bash">    --with-http_ssl_module \</span></span><br><span class="line"><span class="bash">    --with-http_realip_module \</span></span><br><span class="line"><span class="bash">    --with-http_addition_module \</span></span><br><span class="line"><span class="bash">    --with-http_sub_module \</span></span><br><span class="line"><span class="bash">    --with-http_dav_module \</span></span><br><span class="line"><span class="bash">    --with-http_flv_module \</span></span><br><span class="line"><span class="bash">    --with-http_mp4_module \</span></span><br><span class="line"><span class="bash">    --with-http_gunzip_module \</span></span><br><span class="line"><span class="bash">    --with-http_gzip_static_module \</span></span><br><span class="line"><span class="bash">    --with-http_random_index_module \</span></span><br><span class="line"><span class="bash">    --with-http_secure_link_module \</span></span><br><span class="line"><span class="bash">    --with-http_stub_status_module \</span></span><br><span class="line"><span class="bash">    --with-http_auth_request_module \</span></span><br><span class="line"><span class="bash">    --with-mail \</span></span><br><span class="line"><span class="bash">    --with-mail_ssl_module \</span></span><br><span class="line"><span class="bash">    --with-file-aio \</span></span><br><span class="line"><span class="bash">    --with-http_v2_module \</span></span><br><span class="line"><span class="bash">    --with-threads \</span></span><br><span class="line"><span class="bash">    --with-stream \</span></span><br><span class="line"><span class="bash">    --with-stream_ssl_module \</span></span><br><span class="line"><span class="bash">    --with-ipv6</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> make &amp;&amp; make install    </span></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> PATH $PATH:$&#123;NGINX_HOME&#125;/sbin</span><br><span class="line"><span class="comment"># 创建WebApp目录</span></span><br><span class="line"><span class="keyword">ENV</span> WEB_APP /usr/share/nginx/html</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p <span class="variable">$&#123;WEB_APP&#125;</span></span></span><br><span class="line"><span class="comment"># 设置默认工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$&#123;WEB_APP&#125;</span></span></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">443</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">22</span></span><br><span class="line"><span class="comment"># 清除nginx源码包</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> rm -rf /usr/<span class="built_in">local</span>/src/nginx*</span></span><br><span class="line"><span class="comment"># 启动sshd和nginx服务</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="variable">$&#123;NGINX_HOME&#125;</span>/sbin/nginx -g <span class="string">'daemon off;'</span> -c <span class="variable">$&#123;NGINX_NGINX&#125;</span>/conf/nginx.conf &amp;&amp; /run.sh</span></span><br></pre></td></tr></table></figure><h4 id="构建本地镜像"><a href="#构建本地镜像" class="headerlink" title="构建本地镜像"></a>构建本地镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t centos8_nginx1.16.1:latest .</span><br></pre></td></tr></table></figure><h4 id="给本地镜像打上tag"><a href="#给本地镜像打上tag" class="headerlink" title="给本地镜像打上tag"></a>给本地镜像打上tag</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag centos8_nginx1.16.1:latest saburo90/centos8-nginx:latest</span><br></pre></td></tr></table></figure><h4 id="将本地镜像push到Docker-Hub仓库"><a href="#将本地镜像push到Docker-Hub仓库" class="headerlink" title="将本地镜像push到Docker Hub仓库"></a>将本地镜像push到Docker Hub仓库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker login</span><br><span class="line">docker push saburo90/centos8-nginx:latest</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;环境准备&quot;&gt;&lt;a href=&quot;#环境准备&quot; class=&quot;headerlink&quot; title=&quot;环境准备&quot;&gt;&lt;/a&gt;环境准备&lt;/h4&gt;
    
    </summary>
    
    
    
      <category term="运维" scheme="http://saburo90.github.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
</feed>
